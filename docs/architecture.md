# Verilog OJ 系统架构设计

## 系统概述

Verilog OJ（Online Judge）是一个专门为 Verilog 硬件描述语言设计的在线判题系统。系统采用微服务架构，将判题功能与用户管理、题库管理等业务模块分离，确保系统的可扩展性和稳定性。

## 架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Frontend    │    │     Backend     │    │  Judge Service  │
│     (Vue.js)    │◄──►│      (Go)       │◄──►│      (Go)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                 │                       │
                                 ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   PostgreSQL    │    │      Redis      │    │   Verilog Tools │
│   (Database)    │    │  (Cache/Queue)  │    │   (iverilog)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 技术栈

### 后端技术
- **主后端**: Go 1.21 + Gin框架
- **判题服务**: Go 1.21 + 独立微服务
- **数据库**: PostgreSQL 15
- **缓存/队列**: Redis 7
- **容器化**: Docker + Docker Compose

### 前端技术（规划中）
- **框架**: Vue 3 + TypeScript
- **构建工具**: Vite
- **UI组件**: Element Plus
- **代码编辑器**: Monaco Editor

### 判题环境
- **Verilog编译器**: iverilog
- **波形查看**: GTKWave
- **操作系统**: Ubuntu 22.04

## 服务架构

### 1. 主后端服务 (Backend)

**职责**:
- 用户管理（注册、登录、权限）
- 题库管理（题目CRUD、测试用例）
- 提交管理（代码提交、结果查询）
- 论坛功能（帖子、回复、点赞）
- 新闻管理（公告、新闻发布）

**核心模块**:
```
backend/
├── cmd/                 # 应用入口
├── internal/
│   ├── models/         # 数据模型
│   ├── handlers/       # HTTP处理器
│   ├── services/       # 业务逻辑
│   ├── middleware/     # 中间件
│   └── config/         # 配置管理
├── api/                # API定义
└── pkg/                # 共享包
```

### 2. 判题服务 (Judge Service)

**职责**:
- 接收判题请求
- Verilog代码编译
- 测试用例执行
- 结果评估和反馈

**核心模块**:
```
judge-service/
├── cmd/                # 应用入口
├── internal/
│   ├── judge/         # 判题核心逻辑
│   ├── queue/         # 消息队列处理
│   └── config/        # 配置管理
└── pkg/               # 共享包
```

### 3. 消息队列通信

**设计思路**:
- 主后端接收用户提交，将判题任务放入Redis队列
- 判题服务从队列获取任务，执行判题
- 判题完成后，通过Redis发布结果
- 主后端订阅结果，更新数据库

**队列流程**:
```
用户提交代码 → 后端验证 → 放入队列 → 判题服务处理 → 发布结果 → 后端更新状态
```

## 数据库设计

### 核心表结构

1. **用户表 (users)**
   - 基本信息：用户名、邮箱、密码
   - 扩展信息：昵称、头像、学校、学号
   - 统计信息：解题数、提交数、积分

2. **题目表 (problems)**
   - 基本信息：标题、描述、输入输出说明
   - 属性：难度、分类、标签
   - 限制：时间限制、内存限制
   - 统计：提交数、通过数

3. **测试用例表 (test_cases)**
   - 关联题目ID
   - 输入输出数据
   - 是否为样例

4. **提交记录表 (submissions)**
   - 关联用户和题目
   - 代码内容和语言
   - 判题结果和详情

5. **论坛表 (forum_posts/replies)**
   - 帖子和回复内容
   - 用户关联和统计

6. **新闻表 (news)**
   - 新闻内容和分类
   - 发布状态和时间

## 安全设计

### 用户认证
- JWT Token认证
- 密码加密存储（bcrypt）
- Token过期时间控制

### 权限控制
- 基于角色的访问控制（RBAC）
- 用户角色：学生、教师、管理员
- API接口权限验证

### 判题安全
- 沙箱环境隔离
- 资源限制（CPU、内存、时间）
- 代码安全检查
- 文件系统隔离

## 部署架构

### Docker容器化
- 每个服务独立容器
- 统一编排管理
- 资源限制和监控

### 网络设计
- 服务间内网通信
- Nginx反向代理
- SSL/TLS加密

### 数据持久化
- 数据库数据卷持久化
- Redis数据持久化
- 判题工作目录隔离

## 扩展性设计

### 水平扩展
- 判题服务可多实例部署
- 负载均衡分发请求
- 队列支持分布式处理

### 垂直扩展
- 资源配置可调整
- 容器资源限制
- 数据库性能优化

### 功能扩展
- 插件化架构设计
- 多语言支持预留
- 第三方集成接口

## 监控与运维

### 日志管理
- 结构化日志输出
- 日志级别控制
- 集中日志收集

### 健康检查
- 服务健康状态监控
- 自动重启机制
- 依赖服务检查

### 性能监控
- 响应时间监控
- 资源使用监控
- 错误率统计

## 开发工作流

### 环境管理
- 开发环境快速搭建
- 生产环境配置分离
- CI/CD流水线集成

### 代码质量
- 代码规范检查
- 单元测试覆盖
- 接口文档同步

### 版本管理
- Git分支策略
- 版本标签管理
- 发布流程规范

## 后续发展规划

### 短期目标
1. 完善基础功能实现
2. 用户界面开发
3. 系统测试和优化

### 中期目标
1. 竞赛模式支持
2. 实时通信功能
3. 数据分析报表

### 长期目标
1. 多校部署支持
2. 云原生架构升级
3. AI辅助功能集成 